@page "/financial-dashboard"
@using Microsoft.AspNetCore.Authorization
@using Shared.DTOs
@using Core.Entities.Enums
@attribute [Authorize(Roles = "Master")]
@inject HttpClient Http
@inject IJSRuntime JS

<div class="page-header-modern">
    <h3>üìà Cash Flow Dashboard</h3>
    <p>Executive financial overview and analytics</p>
</div>

<div class="modern-card mb-4">
    <div class="modern-card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="label-modern">Start Date</label>
                <input type="date" class="input-modern" @bind="startDate" />
            </div>
            <div class="col-md-3">
                <label class="label-modern">End Date</label>
                <input type="date" class="input-modern" @bind="endDate" />
            </div>
            <div class="col-md-4">
                <label class="label-modern">Clinic</label>
                <select class="input-modern" @bind="selectedClinicId">
                    <option value="">All Clinics</option>
                    @foreach (var clinic in availableClinics)
                    {
                        <option value="@clinic.ClinicId">@clinic.ClinicName</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn-modern btn-primary-modern w-100" @onclick="LoadDashboardData">
                    <span>üîç</span> Filter
                </button>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-modern"></div>
        <p class="mt-3 text-muted">Loading analytics...</p>
    </div>
}
else if (dashboardData != null)
{
    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stats-card stats-card-income">
                <div class="stats-card-icon">üí∞</div>
                <div class="stats-card-label">Total Income</div>
                <div class="stats-card-value">$ @dashboardData.TotalIncome.ToString("N2")</div>
                <small class="text-muted-modern">Period Total</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card stats-card-expense">
                <div class="stats-card-icon">üí∏</div>
                <div class="stats-card-label">Total Expenses</div>
                <div class="stats-card-value">$ @dashboardData.TotalExpense.ToString("N2")</div>
                <small class="text-muted-modern">Period Total</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card @(dashboardData.NetBalance >= 0 ? "stats-card-balance-positive" : "stats-card-balance-negative")">
                <div class="stats-card-icon">@(dashboardData.NetBalance >= 0 ? "üìà" : "üìâ")</div>
                <div class="stats-card-label">Net Balance</div>
                <div class="stats-card-value">$ @dashboardData.NetBalance.ToString("N2")</div>
                <small class="text-muted-modern">Income - Expenses</small>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="modern-card h-100">
                <div class="modern-card-header">
                    <h5 class="modern-card-title">Daily Evolution</h5>
                </div>
                <div class="modern-card-body">
                    <canvas id="dailyEvolutionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="modern-card h-100">
                <div class="modern-card-header">
                    <h5 class="modern-card-title">Income vs Expense</h5>
                </div>
                <div class="modern-card-body d-flex align-items-center justify-content-center">
                    <canvas id="compositionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row g-3">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h5 class="modern-card-title">Performance by Clinic</h5>
                </div>
                <div class="modern-card-body">
                    <canvas id="clinicPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DateTime startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    private DateTime endDate = DateTime.Now;
    private Guid? selectedClinicId;
    private List<ClinicSummaryDto> availableClinics = new();
    private FinancialDashboardSummaryDto? dashboardData;
    private bool isLoading = false;
    private int renderKey = 0; // Track when to re-render

    protected override async Task OnInitializedAsync()
    {
        await LoadClinics();
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (dashboardData != null && dashboardData.DailyHistory.Any() && renderKey > 0)
        {
            await Task.Delay(50); // Small delay to ensure DOM is ready
            await RenderCharts();
            renderKey = 0; // Reset after rendering
        }
    }

    private async Task LoadClinics()
    {
        try
        {
            var allClinics = await Http.GetFromJsonAsync<List<ClinicDto>>("clinics");
            availableClinics = allClinics?.Select(c => new ClinicSummaryDto 
            { 
                ClinicId = c.Id, 
                ClinicName = c.Name 
            }).ToList() ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading clinics: {ex.Message}");
        }
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        try
        {
            var url = $"financial-transactions/dashboard?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}";
            if (selectedClinicId.HasValue)
            {
                url += $"&clinicId={selectedClinicId}";
            }

            dashboardData = await Http.GetFromJsonAsync<FinancialDashboardSummaryDto>(url);
            Console.WriteLine($"Dashboard data loaded: {dashboardData?.DailyHistory.Count} days, {dashboardData?.ClinicPerformance.Count} clinics");
            
            renderKey++; // Trigger re-render in OnAfterRenderAsync
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RenderCharts()
    {
        Console.WriteLine("RenderCharts called");
        if (dashboardData == null)
        {
            Console.WriteLine("dashboardData is null");
            return;
        }

        Console.WriteLine($"Rendering charts with {dashboardData.DailyHistory.Count} days, {dashboardData.ClinicPerformance.Count} clinics");

        try
        {
            // Daily Evolution Chart (Line)
            var dates = dashboardData.DailyHistory.Select(d => d.Date.ToString("dd/MM")).ToArray();
            var incomeDatasets = new[]
            {
                new {
                    label = "Income",
                    data = dashboardData.DailyHistory.Select(d => (double)d.Income).ToArray(),
                    borderColor = "#56ab2f",
                    backgroundColor = "rgba(86, 171, 47, 0.1)",
                    fill = true,
                    tension = 0.4
                },
                new {
                    label = "Expense",
                    data = dashboardData.DailyHistory.Select(d => (double)d.Expense).ToArray(),
                    borderColor = "#e74c3c",
                    backgroundColor = "rgba(231, 76, 60, 0.1)",
                    fill = true,
                    tension = 0.4
                }
            };

            await JS.InvokeVoidAsync("renderLineChart",
                "dailyEvolutionChart",
                dates,
                incomeDatasets);

            // Composition Chart (Pie)
            await JS.InvokeVoidAsync("renderPieChart",
                "compositionChart",
                new[] { "Income", "Expense" },
                new[] { (double)dashboardData.TotalIncome, (double)dashboardData.TotalExpense },
                new[] { "#56ab2f", "#e74c3c" });

            // Clinic Performance Chart (Grouped Bars)
            var clinicNames = dashboardData.ClinicPerformance.Select(c => c.ClinicName).ToArray();
            Console.WriteLine($"Clinic names for chart: {string.Join(", ", clinicNames)}");
            
            var clinicDatasets = new[]
            {
                new {
                    label = "Income",
                    data = dashboardData.ClinicPerformance.Select(c => (double)c.Income).ToArray(),
                    backgroundColor = "#56ab2f",
                    borderRadius = 4
                },
                new {
                    label = "Expense",
                    data = dashboardData.ClinicPerformance.Select(c => (double)c.Expense).ToArray(),
                    backgroundColor = "#e74c3c",
                    borderRadius = 4
                },
                new {
                    label = "Balance",
                    data = dashboardData.ClinicPerformance.Select(c => (double)c.Balance).ToArray(),
                    backgroundColor = "#3498db",
                    borderRadius = 4
                }
            };

            await JS.InvokeVoidAsync("renderBarChart",
                "clinicPerformanceChart",
                clinicNames,
                clinicDatasets,
                false);
            
            Console.WriteLine("All charts rendered successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }
}

<style>
    .stats-card-income { border-left: 4px solid #56ab2f; }
    .stats-card-expense { border-left: 4px solid #e74c3c; }
    .stats-card-balance-positive { border-left: 4px solid #3498db; }
    .stats-card-balance-negative { border-left: 4px solid #e67e22; }
</style>
